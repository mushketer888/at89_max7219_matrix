#include <at89Sx051.h>
#include <string.h>

// Define MAX7219 control pins
__sbit __at (0x80) DIN;  // P0.0: Data Input
__sbit __at (0x81) CS;   // P0.1: Chip Select
__sbit __at (0x82) CLK;  // P0.2: Clock

// Font for characters (8x8 matrix)
__code unsigned char font[][8] = { 
    // Digits (0-9)
    {0x3C, 0x66, 0x6E, 0x76, 0x66, 0x66, 0x3C, 0x00}, // '0'
    {0x18, 0x38, 0x18, 0x18, 0x18, 0x18, 0x3C, 0x00}, // '1'
    {0x3C, 0x66, 0x06, 0x0C, 0x18, 0x30, 0x7E, 0x00}, // '2'
    {0x3C, 0x66, 0x06, 0x1C, 0x06, 0x66, 0x3C, 0x00}, // '3'
    {0x0C, 0x1C, 0x2C, 0x4C, 0x7E, 0x0C, 0x1E, 0x00}, // '4'
    {0x7E, 0x60, 0x7C, 0x06, 0x06, 0x66, 0x3C, 0x00}, // '5'
    {0x1C, 0x30, 0x60, 0x7C, 0x66, 0x66, 0x3C, 0x00}, // '6'
    {0x7E, 0x66, 0x06, 0x0C, 0x18, 0x18, 0x18, 0x00}, // '7'
    {0x3C, 0x66, 0x66, 0x3C, 0x66, 0x66, 0x3C, 0x00}, // '8'
    {0x3C, 0x66, 0x66, 0x3E, 0x06, 0x0C, 0x38, 0x00}, // '9'
    
    // Letters (a-z)
    {0x00, 0x3C, 0x06, 0x3E, 0x66, 0x66, 0x3E, 0x00}, // 'a'
    {0x60, 0x60, 0x7C, 0x66, 0x66, 0x66, 0x7C, 0x00}, // 'b'
    {0x00, 0x3C, 0x66, 0x60, 0x60, 0x66, 0x3C, 0x00}, // 'c'
    {0x06, 0x06, 0x3E, 0x66, 0x66, 0x66, 0x3E, 0x00}, // 'd'
    {0x00, 0x3C, 0x66, 0x7E, 0x60, 0x66, 0x3C, 0x00}, // 'e'
    {0x1C, 0x30, 0x7C, 0x30, 0x30, 0x30, 0x30, 0x00}, // 'f'
    {0x00, 0x3E, 0x66, 0x66, 0x3E, 0x06, 0x3C, 0x00}, // 'g'
    {0x60, 0x60, 0x7C, 0x66, 0x66, 0x66, 0x66, 0x00}, // 'h'
    {0x18, 0x00, 0x38, 0x18, 0x18, 0x18, 0x3C, 0x00}, // 'i'
    {0x0C, 0x00, 0x1C, 0x0C, 0x0C, 0x0C, 0x78, 0x00}, // 'j'
    {0x60, 0x60, 0x66, 0x6C, 0x78, 0x6C, 0x66, 0x00}, // 'k'
    {0x38, 0x18, 0x18, 0x18, 0x18, 0x18, 0x3C, 0x00}, // 'l'
    {0x00, 0x7C, 0x6B, 0x6B, 0x6B, 0x63, 0x63, 0x00}, // 'm'
    {0x00, 0x7C, 0x66, 0x66, 0x66, 0x66, 0x66, 0x00}, // 'n'
    {0x00, 0x3C, 0x66, 0x66, 0x66, 0x66, 0x3C, 0x00}, // 'o'
    {0x00, 0x7C, 0x66, 0x66, 0x7C, 0x60, 0x60, 0x00}, // 'p'
    {0x00, 0x3E, 0x66, 0x66, 0x3E, 0x06, 0x06, 0x00}, // 'q'
    {0x00, 0x7C, 0x66, 0x60, 0x60, 0x60, 0x60, 0x00}, // 'r'
    {0x00, 0x3C, 0x60, 0x3C, 0x06, 0x66, 0x3C, 0x00}, // 's'
    {0x30, 0x30, 0x7C, 0x30, 0x30, 0x30, 0x1C, 0x00}, // 't'
    {0x00, 0x66, 0x66, 0x66, 0x66, 0x66, 0x3E, 0x00}, // 'u'
    {0x00, 0x66, 0x66, 0x66, 0x66, 0x3C, 0x18, 0x00}, // 'v'
    {0x00, 0x63, 0x63, 0x6B, 0x6B, 0x7F, 0x36, 0x00}, // 'w'
    {0x00, 0x66, 0x66, 0x3C, 0x18, 0x3C, 0x66, 0x00}, // 'x'
    {0x00, 0x66, 0x66, 0x66, 0x3E, 0x06, 0x3C, 0x00}, // 'y'
    {0x00, 0x7E, 0x0C, 0x18, 0x30, 0x60, 0x7E, 0x00}, // 'z'

    {0x18, 0x3C, 0x66, 0x66, 0x7E, 0x66, 0x66, 0x00}, // 'A'
    {0x7C, 0x66, 0x66, 0x7C, 0x66, 0x66, 0x7C, 0x00}, // 'B'
    {0x3C, 0x66, 0x60, 0x60, 0x60, 0x66, 0x3C, 0x00}, // 'C'
    {0x7C, 0x66, 0x66, 0x66, 0x66, 0x66, 0x7C, 0x00}, // 'D'
    {0x7E, 0x60, 0x60, 0x7C, 0x60, 0x60, 0x7E, 0x00}, // 'E'
    {0x7E, 0x60, 0x60, 0x7C, 0x60, 0x60, 0x60, 0x00}, // 'F'
    {0x3C, 0x66, 0x60, 0x6E, 0x66, 0x66, 0x3C, 0x00}, // 'G'
    {0x66, 0x66, 0x66, 0x7E, 0x66, 0x66, 0x66, 0x00}, // 'H'
    {0x3C, 0x18, 0x18, 0x18, 0x18, 0x18, 0x3C, 0x00}, // 'I'
    {0x1E, 0x0C, 0x0C, 0x0C, 0x0C, 0x6C, 0x38, 0x00}, // 'J'
    {0x66, 0x6C, 0x78, 0x70, 0x78, 0x6C, 0x66, 0x00}, // 'K'
    {0x60, 0x60, 0x60, 0x60, 0x60, 0x60, 0x7E, 0x00}, // 'L'
    {0x63, 0x77, 0x7F, 0x7F, 0x6B, 0x63, 0x63, 0x00}, // 'M'
    {0x66, 0x76, 0x7E, 0x7E, 0x6E, 0x66, 0x66, 0x00}, // 'N'
    {0x3C, 0x66, 0x66, 0x66, 0x66, 0x66, 0x3C, 0x00}, // 'O'
    {0x7C, 0x66, 0x66, 0x7C, 0x60, 0x60, 0x60, 0x00}, // 'P'
    {0x3C, 0x66, 0x66, 0x66, 0x66, 0x6C, 0x36, 0x00}, // 'Q'
    {0x7C, 0x66, 0x66, 0x7C, 0x78, 0x6C, 0x66, 0x00}, // 'R'
    {0x3C, 0x66, 0x60, 0x3C, 0x06, 0x66, 0x3C, 0x00}, // 'S'
    {0x7E, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x00}, // 'T'
    {0x66, 0x66, 0x66, 0x66, 0x66, 0x66, 0x3C, 0x00}, // 'U'
    {0x66, 0x66, 0x66, 0x66, 0x66, 0x3C, 0x18, 0x00}, // 'V'
    {0x63, 0x63, 0x63, 0x6B, 0x6B, 0x7F, 0x36, 0x00}, // 'W'
    {0x66, 0x66, 0x3C, 0x18, 0x3C, 0x66, 0x66, 0x00}, // 'X'
    {0x66, 0x66, 0x66, 0x3C, 0x18, 0x18, 0x18, 0x00}, // 'Y'
    {0x7E, 0x06, 0x0C, 0x18, 0x30, 0x60, 0x7E, 0x00}  // 'Z'
    //you will need to add additional ones
};

// Font for space
__code unsigned char space[8] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};
#define NUM_DISPLAYS 4    // Number of cascaded MAX7219s
#define SCROLL_DELAY 10 * 1000  // Scroll speed (adjust as needed). This one is fine for 16MHZ crystal

// Simple delay function
void delay(unsigned int time) {
    unsigned int i, j;
    for (i = 0; i < time; i++)
        for (j = 0; j < 14; j++);  // 14 iterations for approx 10ÂµS at 16MHz
}

// Send a byte to MAX7219
void sendByte(unsigned char data) {
    unsigned char i;
    for (i = 0; i < 8; i++) {
        CLK = 0;
        //delay(1);
        DIN = (data & 0x80) ? 1 : 0;
        //delay(1);
        data <<= 1;
        CLK = 1;
        //delay(1);
    }
}

// Send command to all MAX7219s
void sendToAll(unsigned char reg, unsigned char data) {
    unsigned char i;
    CS = 0;
    for (i = 0; i < NUM_DISPLAYS; i++) {
        sendByte(reg);
        sendByte(data);
    }
    CS = 1;
    //delay(1);
}

// Initialize all MAX7219s
void initMAX7219() {
    sendToAll(0x09, 0x00);      // No decoding
    sendToAll(0x0A, 0x07);      // Intensity 0x01-0x0f
    sendToAll(0x0B, 0x07);      // Scan all digits
    sendToAll(0x0C, 0x01);      // Normal operation
    sendToAll(0x0F, 0x00);      // No display test
    
    // Clear all displays
    unsigned char i;
    for (i = 1; i <= 8; i++) {
        sendToAll(i, 0x00);
    }
}

// Send data to specific display and row
void sendToDisplay(unsigned char display, unsigned char row, unsigned char data) {
    unsigned char i;
    CS = 0;
    //delay(10);
    
    // Send no-op to displays before target
    for (i = 0; i < (NUM_DISPLAYS - 1 - display); i++) {
        sendByte(0x00);
        sendByte(0x00);
    }
    
    // Send data to target display
    sendByte(row);
    sendByte(data);
    
    // Send no-op to remaining displays
    for (i = 0; i < display; i++) {
        sendByte(0x00);
        sendByte(0x00);
    }
    
    CS = 1;
    //delay(10);
}

// Get character pattern from font array
void getCharPattern(char c, unsigned char *pattern) {
    unsigned char i, j, rotated;
    unsigned char tempPattern[8];
    
    // Get original pattern
    if (c == ' ') {
        for (i = 0; i < 8; i++) tempPattern[i] = space[i];
    }
    else if (c >= '0' && c <= '9') {
        for (i = 0; i < 8; i++) tempPattern[i] = font[c - '0'][i];
    }
    else if (c >= 'a' && c <= 'z') {
        for (i = 0; i < 8; i++) tempPattern[i] = font[c - 'a' + 10][i];
    }
    else if (c >= 'A' && c <= 'Z') {
        for (i = 0; i < 8; i++) tempPattern[i] = font[c - 'A' + 36][i];
    }
    else {
        for (i = 0; i < 8; i++) tempPattern[i] = 0x00;
    }
    
     // Rotate 180 degrees
    for (i = 0; i < 8; i++) {
        pattern[7-i] = (tempPattern[i] & 0x80 ? 0x01 : 0) |
                       (tempPattern[i] & 0x40 ? 0x02 : 0) |
                       (tempPattern[i] & 0x20 ? 0x04 : 0) |
                       (tempPattern[i] & 0x10 ? 0x08 : 0) |
                       (tempPattern[i] & 0x08 ? 0x10 : 0) |
                       (tempPattern[i] & 0x04 ? 0x20 : 0) |
                       (tempPattern[i] & 0x02 ? 0x40 : 0) |
                       (tempPattern[i] & 0x01 ? 0x80 : 0);
    }
}

// Display string across all displays
void displayString(char *str) {
    unsigned char i, j;
    unsigned char pattern[8];
    unsigned char currentDisplay = 0;
    char *currentChar = str;
    
    // Clear all displays first
    for (i = 0; i < NUM_DISPLAYS; i++) {
        for (j = 1; j <= 8; j++) {
            sendToDisplay(i, j, 0x00);
        }
    }
    
    // Display characters
    while (currentDisplay < NUM_DISPLAYS && *currentChar) {
        getCharPattern(*currentChar, pattern);
        
        // Send pattern to current display
        for (i = 0; i < 8; i++) {
            sendToDisplay(currentDisplay, i + 1, pattern[i]);
        }
        
        currentDisplay++;
        currentChar++;
    }
}

void scrollString(char *str) {
    unsigned int pos;
    unsigned int len = strlen(str);
    char displayBuffer[NUM_DISPLAYS + 1];
    
    for (pos = 0; pos < len + NUM_DISPLAYS; pos++) {
        // Fill buffer with current characters to display
        for (int i = 0; i < NUM_DISPLAYS; i++) {
            int charPos = pos - (NUM_DISPLAYS - 1 - i);
            displayBuffer[i] = (charPos >= 0 && charPos < len) ? str[charPos] : ' ';
        }
        displayBuffer[NUM_DISPLAYS] = '\0';
        
        displayString(displayBuffer);
        delay(SCROLL_DELAY);
    }
}

void main() {
    initMAX7219();
    //displayString("TEST");
    //delay(100);
    
    while(1) {
        initMAX7219();//to make more reliable because of wiring
        scrollString("Happy New Year");
    }
}